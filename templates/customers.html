
{% extends "layout.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-users"></i> Customer Management</h1>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-primary" id="add-customer-btn">
                <i class="fas fa-plus"></i> Add Customer
            </button>
            <button type="button" class="btn btn-outline-secondary" id="import-customers-btn">
                <i class="fas fa-upload"></i> Import
            </button>
            <button type="button" class="btn btn-outline-secondary" id="export-customers-btn">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </div>

    <!-- Customer Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Customers</h6>
                            <h3 id="total-customers">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Active Customers</h6>
                            <h3 id="active-customers">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-user-check fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Avg Order Value</h6>
                            <h3 id="avg-order-value">TZS 0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-dollar-sign fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Top Customer CLV</h6>
                            <h3 id="top-clv">TZS 0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-crown fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="customer-search" placeholder="Search customers...">
            </div>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="customer-type-filter">
                <option value="">All Types</option>
                <option value="retail">Retail</option>
                <option value="wholesale">Wholesale</option>
                <option value="vip">VIP</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="loyalty-tier-filter">
                <option value="">All Tiers</option>
                <option value="bronze">Bronze</option>
                <option value="silver">Silver</option>
                <option value="gold">Gold</option>
                <option value="platinum">Platinum</option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-outline-secondary w-100" id="reset-filters">
                <i class="fas fa-times"></i> Reset
            </button>
        </div>
    </div>

    <!-- Customer Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Contact</th>
                            <th>Type</th>
                            <th>Total Purchases</th>
                            <th>Total Spent</th>
                            <th>Avg Order Value</th>
                            <th>Last Purchase</th>
                            <th>Loyalty Tier</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customers-table">
                        <!-- Customer data will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <!-- No customers message -->
            <div id="no-customers-message" class="text-center py-4 d-none">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <p class="text-muted">No customers found. Start by adding your first customer!</p>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('add-customer-btn').click()">
                    <i class="fas fa-plus"></i> Add Customer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Customer Detail Modal -->
<div class="modal fade" id="customerDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Customer Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="customer-detail-content">
                    <!-- Customer details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="edit-customer-btn">Edit Customer</button>
            </div>
        </div>
    </div>
</div>

<!-- Customer Form Modal -->
<div class="modal fade" id="customerFormModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerFormModalLabel">Add Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="customer-form">
                    <input type="hidden" id="customer-id">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="customer-name" class="form-label">Name *</label>
                            <input type="text" class="form-control" id="customer-name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="customer-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="customer-email">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="customer-phone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="customer-phone">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="customer-type" class="form-label">Customer Type</label>
                            <select class="form-select" id="customer-type">
                                <option value="retail">Retail</option>
                                <option value="wholesale">Wholesale</option>
                                <option value="vip">VIP</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="customer-address" class="form-label">Address</label>
                        <textarea class="form-control" id="customer-address" rows="2"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="customer-credit-limit" class="form-label">Credit Limit</label>
                            <input type="number" class="form-control" id="customer-credit-limit" min="0" step="0.01">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="customer-payment-method" class="form-label">Preferred Payment</label>
                            <select class="form-select" id="customer-payment-method">
                                <option value="cash">Cash</option>
                                <option value="mobile_money">Mobile Money</option>
                                <option value="card">Card</option>
                                <option value="bank_transfer">Bank Transfer</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="customer-marketing-consent" checked>
                        <label class="form-check-label" for="customer-marketing-consent">
                            Allow marketing communications
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-customer-btn">Save Customer</button>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/customers.js"></script>
{% endblock %}
{% extends 'layout.html' %}

{% block content %}
<div class="container-fluid my-4">
    <!-- Customer Management Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1"><i class="fas fa-users me-2 text-primary"></i>Customer Management</h2>
                    <p class="text-muted mb-0">Manage customer relationships and track purchase history</p>
                </div>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
                        <i class="fas fa-user-plus me-2"></i>Add Customer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Statistics -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm bg-primary bg-opacity-10">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="text-primary mb-1" id="totalCustomersCount">0</h4>
                            <p class="text-muted mb-0">Total Customers</p>
                        </div>
                        <i class="fas fa-users fa-2x text-primary opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm bg-success bg-opacity-10">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="text-success mb-1" id="activeCustomersCount">0</h4>
                            <p class="text-muted mb-0">Active Customers</p>
                        </div>
                        <i class="fas fa-user-check fa-2x text-success opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm bg-info bg-opacity-10">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="text-info mb-1" id="totalRevenueCount">$0</h4>
                            <p class="text-muted mb-0">Total Revenue</p>
                        </div>
                        <i class="fas fa-dollar-sign fa-2x text-info opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm bg-warning bg-opacity-10">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="text-warning mb-1" id="avgOrderValue">$0</h4>
                            <p class="text-muted mb-0">Avg Order Value</p>
                        </div>
                        <i class="fas fa-shopping-cart fa-2x text-warning opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom">
                    <ul class="nav nav-tabs card-header-tabs" id="customerTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="customers-tab" data-bs-toggle="tab" data-bs-target="#customers" type="button" role="tab">
                                <i class="fas fa-users me-2"></i>All Customers
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                                <i class="fas fa-chart-line me-2"></i>Customer Analytics
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="loyalty-tab" data-bs-toggle="tab" data-bs-target="#loyalty" type="button" role="tab">
                                <i class="fas fa-star me-2"></i>Loyalty Program
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body p-0">
                    <div class="tab-content" id="customerTabsContent">
                        <!-- All Customers Tab -->
                        <div class="tab-pane fade show active" id="customers" role="tabpanel">
                            <div class="p-4">
                                <!-- Search and Filter Controls -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" class="form-control" id="customerSearch" placeholder="Search customers...">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="customerTypeFilter">
                                            <option value="">All Types</option>
                                            <option value="vip">VIP</option>
                                            <option value="regular">Regular</option>
                                            <option value="new">New</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="customerStatusFilter">
                                            <option value="">All Status</option>
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-outline-secondary w-100" id="refreshCustomers">
                                            <i class="fas fa-sync-alt me-1"></i>Refresh
                                        </button>
                                    </div>
                                </div>

                                <!-- Customers Table -->
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th scope="col">Customer</th>
                                                <th scope="col">Contact</th>
                                                <th scope="col">Total Purchases</th>
                                                <th scope="col">Total Spent</th>
                                                <th scope="col">Avg Order Value</th>
                                                <th scope="col">Last Purchase</th>
                                                <th scope="col" class="text-end">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="customersTableBody">
                                            <tr>
                                                <td colspan="7" class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <p class="text-muted mt-2">Loading customers...</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Customer Analytics Tab -->
                        <div class="tab-pane fade" id="analytics" role="tabpanel">
                            <div class="p-4">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Customer Segmentation</h6>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="customerSegmentChart" width="400" height="300"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Purchase Frequency</h6>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="purchaseFrequencyChart" width="400" height="300"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Loyalty Program Tab -->
                        <div class="tab-pane fade" id="loyalty" role="tabpanel">
                            <div class="p-4">
                                <h5>Loyalty Program Management</h5>
                                <p class="text-muted">Create and manage customer loyalty programs and rewards.</p>
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Loyalty program features coming soon! This will include points tracking, reward tiers, and automated promotions.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Customer Modal -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCustomerForm">
                    <div class="mb-3">
                        <label for="customerName" class="form-label">Customer Name *</label>
                        <input type="text" class="form-control" id="customerName" required>
                    </div>
                    <div class="mb-3">
                        <label for="customerPhone" class="form-label">Phone Number *</label>
                        <input type="tel" class="form-control" id="customerPhone" required>
                    </div>
                    <div class="mb-3">
                        <label for="customerEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="customerEmail">
                    </div>
                    <div class="mb-3">
                        <label for="customerAddress" class="form-label">Address</label>
                        <textarea class="form-control" id="customerAddress" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="customerType" class="form-label">Customer Type</label>
                        <select class="form-select" id="customerType">
                            <option value="regular">Regular</option>
                            <option value="vip">VIP</option>
                            <option value="wholesale">Wholesale</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCustomerBtn">Save Customer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize customer management
    initializeCustomerManagement();

    function initializeCustomerManagement() {
        loadCustomers();
        initializeEventListeners();
        initializeCharts();
    }

    function initializeEventListeners() {
        // Search and filter
        document.getElementById('customerSearch').addEventListener('input', filterCustomers);
        document.getElementById('customerTypeFilter').addEventListener('change', filterCustomers);
        document.getElementById('customerStatusFilter').addEventListener('change', filterCustomers);
        
        // Refresh button
        document.getElementById('refreshCustomers').addEventListener('click', loadCustomers);
        
        // Save customer
        document.getElementById('saveCustomerBtn').addEventListener('click', saveCustomer);
    }

    function loadCustomers() {
        fetch('/api/customers')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderCustomersTable(data.customers);
                    updateStatistics(data.customers);
                } else {
                    showAlert('Failed to load customers', 'danger');
                }
            })
            .catch(error => {
                console.error('Error loading customers:', error);
                showAlert('Error loading customers', 'danger');
            });
    }

    function renderCustomersTable(customers) {
        const tbody = document.getElementById('customersTableBody');
        
        if (!customers || customers.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No customers found</p>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = customers.map(customer => `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-2">
                            <span class="text-white small fw-bold">${customer.name.charAt(0).toUpperCase()}</span>
                        </div>
                        <div>
                            <div class="fw-semibold">${customer.name}</div>
                            <small class="text-muted">Customer since ${new Date(customer.first_purchase_date).toLocaleDateString()}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <div>
                        <i class="fas fa-phone me-1"></i>${customer.phone}
                    </div>
                </td>
                <td>
                    <span class="badge bg-primary">${customer.total_purchases}</span>
                </td>
                <td>
                    <strong>$${customer.total_spent.toFixed(2)}</strong>
                </td>
                <td>
                    $${customer.average_order_value.toFixed(2)}
                </td>
                <td>
                    <small class="text-muted">${new Date(customer.last_purchase_date).toLocaleDateString()}</small>
                </td>
                <td class="text-end">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" title="View Details" onclick="viewCustomer('${customer.name}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-primary" title="Create Sale" onclick="createSaleForCustomer('${customer.name}', '${customer.phone}')">
                            <i class="fas fa-shopping-cart"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function updateStatistics(customers) {
        const totalCustomers = customers.length;
        const activeCustomers = customers.filter(c => new Date(c.last_purchase_date) > new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)).length;
        const totalRevenue = customers.reduce((sum, c) => sum + c.total_spent, 0);
        const avgOrderValue = customers.length > 0 ? customers.reduce((sum, c) => sum + c.average_order_value, 0) / customers.length : 0;

        document.getElementById('totalCustomersCount').textContent = totalCustomers;
        document.getElementById('activeCustomersCount').textContent = activeCustomers;
        document.getElementById('totalRevenueCount').textContent = `$${totalRevenue.toFixed(2)}`;
        document.getElementById('avgOrderValue').textContent = `$${avgOrderValue.toFixed(2)}`;
    }

    function initializeCharts() {
        // Customer Segmentation Chart
        const segmentCtx = document.getElementById('customerSegmentChart').getContext('2d');
        new Chart(segmentCtx, {
            type: 'doughnut',
            data: {
                labels: ['New Customers', 'Regular', 'VIP', 'Inactive'],
                datasets: [{
                    data: [25, 45, 20, 10],
                    backgroundColor: ['#28a745', '#007bff', '#ffc107', '#dc3545']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // Purchase Frequency Chart
        const frequencyCtx = document.getElementById('purchaseFrequencyChart').getContext('2d');
        new Chart(frequencyCtx, {
            type: 'bar',
            data: {
                labels: ['Weekly', 'Monthly', 'Quarterly', 'Rarely'],
                datasets: [{
                    label: 'Customers',
                    data: [15, 35, 25, 25],
                    backgroundColor: '#007bff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function filterCustomers() {
        // Implementation for filtering customers
        const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
        const typeFilter = document.getElementById('customerTypeFilter').value;
        const statusFilter = document.getElementById('customerStatusFilter').value;
        
        // Filter logic would go here
    }

    function saveCustomer() {
        const customerData = {
            name: document.getElementById('customerName').value,
            phone: document.getElementById('customerPhone').value,
            email: document.getElementById('customerEmail').value,
            address: document.getElementById('customerAddress').value,
            type: document.getElementById('customerType').value
        };

        // For now, just show success message
        // In real implementation, this would save to database
        showAlert('Customer saved successfully!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('addCustomerModal')).hide();
        document.getElementById('addCustomerForm').reset();
    }

    window.viewCustomer = function(customerName) {
        // Implementation for viewing customer details
        showAlert(`Viewing details for ${customerName}`, 'info');
    };

    window.createSaleForCustomer = function(name, phone) {
        // Redirect to sales page with customer pre-filled
        window.location.href = `/sales?customer_name=${encodeURIComponent(name)}&customer_phone=${encodeURIComponent(phone)}`;
    };

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);

        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %}
