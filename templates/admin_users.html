{% extends 'layout.html' %}

{% block content %}
<div class="container-fluid my-4">
    <!-- Admin Dashboard Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1"><i class="fas fa-shield-alt me-2 text-primary"></i>Admin Portal</h2>
                    <p class="text-muted mb-0">Manage users, permissions, and system settings</p>
                </div>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                        <i class="fas fa-user-plus me-2"></i>Add New User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Statistics -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm bg-primary bg-opacity-10">
                <div class="card-body text-center">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="text-primary mb-1" id="totalUsersCount">{{ users|length }}</h4>
                            <p class="text-muted mb-0">Total Users</p>
                        </div>
                        <i class="fas fa-users fa-2x text-primary opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm bg-success bg-opacity-10">
                <div class="card-body text-center">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="text-success mb-1" id="activeUsersCount">{{ users|selectattr('active')|list|length }}</h4>
                            <p class="text-muted mb-0">Active Users</p>
                        </div>
                        <i class="fas fa-user-check fa-2x text-success opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm bg-info bg-opacity-10">
                <div class="card-body text-center">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="text-info mb-1" id="adminUsersCount">{{ users|selectattr('is_admin')|list|length }}</h4>
                            <p class="text-muted mb-0">Admin Users</p>
                        </div>
                        <i class="fas fa-user-shield fa-2x text-info opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm bg-warning bg-opacity-10">
                <div class="card-body text-center">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="text-warning mb-1" id="unverifiedUsersCount">{{ users|rejectattr('email_verified')|list|length }}</h4>
                            <p class="text-muted mb-0">Unverified</p>
                        </div>
                        <i class="fas fa-user-times fa-2x text-warning opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom">
                    <ul class="nav nav-tabs card-header-tabs" id="adminTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                                <i class="fas fa-users me-2"></i>User Management
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="permissions-tab" data-bs-toggle="tab" data-bs-target="#permissions" type="button" role="tab">
                                <i class="fas fa-key me-2"></i>Permissions
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button" role="tab">
                                <i class="fas fa-cogs me-2"></i>System Settings
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">
                                <i class="fas fa-list-alt me-2"></i>Activity Logs
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body p-0">
                    <div class="tab-content" id="adminTabsContent">
                        <!-- User Management Tab -->
                        <div class="tab-pane fade show active" id="users" role="tabpanel">
                            <div class="p-4">
                                <!-- Search and Filter Controls -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" class="form-control" id="userSearch" placeholder="Search users...">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="userStatusFilter">
                                            <option value="">All Status</option>
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="userRoleFilter">
                                            <option value="">All Roles</option>
                                            <option value="admin">Admin</option>
                                            <option value="user">User</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-outline-secondary w-100" id="refreshUsers">
                                            <i class="fas fa-sync-alt me-1"></i>Refresh
                                        </button>
                                    </div>
                                </div>

                                <!-- Users Table -->
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th scope="col">
                                                    <input type="checkbox" class="form-check-input" id="selectAllUsers">
                                                </th>
                                                <th scope="col">User</th>
                                                <th scope="col">Email</th>
                                                <th scope="col">Status</th>
                                                <th scope="col">Role</th>
                                                <th scope="col">Last Login</th>
                                                <th scope="col">Created</th>
                                                <th scope="col" class="text-end">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersTableBody">
                                            {% for user in users %}
                                            <tr data-user-id="{{ user.id }}">
                                                <td>
                                                    <input type="checkbox" class="form-check-input user-checkbox" value="{{ user.id }}">
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-2">
                                                            <span class="text-white small fw-bold">{{ user.username[0]|upper }}</span>
                                                        </div>
                                                        <div>
                                                            <div class="fw-semibold">{{ user.username }}</div>
                                                            <small class="text-muted">{{ user.first_name }} {{ user.last_name }}</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div>
                                                        {{ user.email }}
                                                        {% if not user.email_verified %}
                                                            <span class="badge bg-warning ms-1" title="Email not verified">
                                                                <i class="fas fa-exclamation-triangle"></i>
                                                            </span>
                                                        {% else %}
                                                            <span class="badge bg-success ms-1" title="Email verified">
                                                                <i class="fas fa-check"></i>
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="badge bg-{{ 'success' if user.active else 'danger' }}">
                                                        {{ 'Active' if user.active else 'Inactive' }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-{{ 'primary' if user.is_admin else 'secondary' }}">
                                                        {{ 'Admin' if user.is_admin else 'User' }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <small class="text-muted">
                                                        {{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}
                                                    </small>
                                                </td>
                                                <td>
                                                    <small class="text-muted">{{ user.created_at.strftime('%Y-%m-%d') }}</small>
                                                </td>
                                                <td class="text-end">
                                                    <div class="btn-group btn-group-sm">
                                                        <button type="button" class="btn btn-outline-secondary edit-user-btn" title="Edit User" data-user-id="{{ user.id }}">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-{% if user.active %}warning{% else %}success{% endif %} toggle-status-btn" title="{% if user.active %}Deactivate{% else %}Activate{% endif %} User" data-user-id="{{ user.id }}">
                                                            <i class="fas fa-{{ user.active ? 'ban' : 'check' }}"></i>
                                                        </button>
                                                        {% if user.id != session.get('user_id') %}
                                                        <button type="button" class="btn btn-outline-danger delete-user-btn" title="Delete User" data-user-id="{{ user.id }}">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Bulk Actions -->
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <div id="bulkActions" class="d-none">
                                        <span class="text-muted me-2">Selected: <span id="selectedCount">0</span> users</span>
                                        <button class="btn btn-sm btn-outline-warning me-2" id="bulkDeactivate">
                                            <i class="fas fa-ban me-1"></i>Deactivate
                                        </button>
                                        <button class="btn btn-sm btn-outline-success me-2" id="bulkActivate">
                                            <i class="fas fa-check me-1"></i>Activate
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" id="bulkDelete">
                                            <i class="fas fa-trash me-1"></i>Delete
                                        </button>
                                    </div>
                                    <div class="ms-auto">
                                        <small class="text-muted">Total: {{ users|length }} users</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Permissions Tab -->
                        <div class="tab-pane fade" id="permissions" role="tabpanel">
                            <div class="p-4">
                                <h5>User Permissions Overview</h5>
                                <p class="text-muted">Manage user roles and permissions across the system.</p>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Permission Categories</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="list-group list-group-flush">
                                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                                        Inventory Management
                                                        <span class="badge bg-primary rounded-pill">5</span>
                                                    </div>
                                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                                        Sales Management
                                                        <span class="badge bg-success rounded-pill">3</span>
                                                    </div>
                                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                                        Financial Reports
                                                        <span class="badge bg-info rounded-pill">4</span>
                                                    </div>
                                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                                        System Administration
                                                        <span class="badge bg-warning rounded-pill">2</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Role Distribution</h6>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="roleDistributionChart" width="400" height="200"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Settings Tab -->
                        <div class="tab-pane fade" id="system" role="tabpanel">
                            <div class="p-4">
                                <h5>System Settings</h5>
                                <p class="text-muted">Configure system-wide settings and preferences.</p>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Security Settings</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="form-check form-switch mb-3">
                                                    <input class="form-check-input" type="checkbox" id="requireEmailVerification" checked>
                                                    <label class="form-check-label" for="requireEmailVerification">
                                                        Require Email Verification
                                                    </label>
                                                </div>
                                                <div class="form-check form-switch mb-3">
                                                    <input class="form-check-input" type="checkbox" id="enableTwoFactor">
                                                    <label class="form-check-label" for="enableTwoFactor">
                                                        Enable Two-Factor Authentication
                                                    </label>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="sessionTimeout" class="form-label">Session Timeout (minutes)</label>
                                                    <input type="number" class="form-control" id="sessionTimeout" value="60">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">System Preferences</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label for="defaultTheme" class="form-label">Default Theme</label>
                                                    <select class="form-select" id="defaultTheme">
                                                        <option value="tanzanite">Tanzanite</option>
                                                        <option value="emerald">Emerald</option>
                                                        <option value="ruby">Ruby</option>
                                                        <option value="sunset">Sunset</option>
                                                        <option value="ocean">Ocean</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="defaultLanguage" class="form-label">Default Language</label>
                                                    <select class="form-select" id="defaultLanguage">
                                                        <option value="en">English</option>
                                                        <option value="es">Spanish</option>
                                                        <option value="fr">French</option>
                                                    </select>
                                                </div>
                                                <button class="btn btn-primary">Save Settings</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Activity Logs Tab -->
                        <div class="tab-pane fade" id="logs" role="tabpanel">
                            <div class="p-4">
                                <h5>Activity Logs</h5>
                                <p class="text-muted">Monitor user activities and system events.</p>

                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Timestamp</th>
                                                <th>User</th>
                                                <th>Action</th>
                                                <th>Details</th>
                                                <th>IP Address</th>
                                            </tr>
                                        </thead>
                                        <tbody id="activityLogsTable">
                                            <tr>
                                                <td colspan="5" class="text-center text-muted py-4">
                                                    <i class="fas fa-info-circle me-2"></i>No activity logs available
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="mb-3">
                        <label for="newUsername" class="form-label">Username *</label>
                        <input type="text" class="form-control" id="newUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="newEmail" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="newEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="newFirstName" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="newFirstName">
                    </div>
                    <div class="mb-3">
                        <label for="newLastName" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="newLastName">
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">Password *</label>
                        <input type="password" class="form-control" id="newPassword" required>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="newIsActive" checked>
                        <label class="form-check-label" for="newIsActive">Active</label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="newIsAdmin">
                        <label class="form-check-label" for="newIsAdmin">Admin</label>
                    </div>
                    <div class="alert alert-danger d-none" id="addUserError" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span id="addErrorMessage">Error message</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveNewUserBtn">Create User</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="mb-3">
                        <label for="editUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="editUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editEmail" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editFirstName" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="editFirstName">
                    </div>
                    <div class="mb-3">
                        <label for="editLastName" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="editLastName">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editIsActive">
                        <label class="form-check-label" for="editIsActive">Active</label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editIsAdmin">
                        <label class="form-check-label" for="editIsAdmin">Admin</label>
                    </div>
                    <div class="alert alert-danger d-none" id="editUserError" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span id="editErrorMessage">Error message</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveUserBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize admin portal
    initializeAdminPortal();

    function initializeAdminPortal() {
        // Load statistics
        loadUserStatistics();

        // Initialize event listeners
        initializeEventListeners();

        // Initialize role distribution chart
        initializeRoleChart();

        // Load initial data
        loadUsersData();
    }

    function loadUserStatistics() {
        fetch('/api/auth/users/stats')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading statistics:', data.error);
                    return;
                }

                document.getElementById('totalUsersCount').textContent = data.total_users || 0;
                document.getElementById('activeUsersCount').textContent = data.active_users || 0;
                document.getElementById('adminUsersCount').textContent = data.admin_users || 0;
                document.getElementById('unverifiedUsersCount').textContent = data.unverified_users || 0;
            })
            .catch(error => {
                console.error('Error loading user statistics:', error);
            });
    }

    function initializeEventListeners() {
        // Search functionality
        document.getElementById('userSearch').addEventListener('input', filterUsers);
        document.getElementById('userStatusFilter').addEventListener('change', filterUsers);
        document.getElementById('userRoleFilter').addEventListener('change', filterUsers);

        // Refresh button
        document.getElementById('refreshUsers').addEventListener('click', function() {
            loadUsersData();
            loadUserStatistics();
        });

        // Select all checkbox
        document.getElementById('selectAllUsers').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(cb => cb.checked = this.checked);
            updateBulkActions();
        });

        // Individual checkboxes
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('user-checkbox')) {
                updateBulkActions();
            }
        });

        // User action buttons
        document.addEventListener('click', function(e) {
            if (e.target.closest('.edit-user-btn')) {
                const userId = e.target.closest('.edit-user-btn').dataset.userId;
                editUser(userId);
            } else if (e.target.closest('.toggle-status-btn')) {
                const userId = e.target.closest('.toggle-status-btn').dataset.userId;
                toggleUserStatus(userId);
            } else if (e.target.closest('.delete-user-btn')) {
                const userId = e.target.closest('.delete-user-btn').dataset.userId;
                deleteUser(userId);
            }
        });

        // Modal form submissions
        document.getElementById('saveNewUserBtn').addEventListener('click', createNewUser);
        document.getElementById('saveUserBtn').addEventListener('click', saveUserChanges);

        // Bulk actions
        document.getElementById('bulkActivate').addEventListener('click', () => bulkAction('activate'));
        document.getElementById('bulkDeactivate').addEventListener('click', () => bulkAction('deactivate'));
        document.getElementById('bulkDelete').addEventListener('click', () => bulkAction('delete'));
    }

    function initializeRoleChart() {
        const ctx = document.getElementById('roleDistributionChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Admin Users', 'Regular Users'],
                datasets: [{
                    data: [{{ users|selectattr('is_admin')|list|length }}, {{ users|rejectattr('is_admin')|list|length }}],
                    backgroundColor: ['#0d6efd', '#6c757d'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function loadUsersData() {
        fetch('/api/auth/users')
            .then(response => response.json())
            .then(users => {
                if (Array.isArray(users)) {
                    renderUsersTable(users);
                } else {
                    console.error('Invalid users data:', users);
                }
            })
            .catch(error => {
                console.error('Error loading users:', error);
                showAlert('Failed to load users data', 'danger');
            });
    }

    function renderUsersTable(users) {
        const tbody = document.getElementById('usersTableBody');

        if (users.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No users found</p>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = users.map(user => `
            <tr data-user-id="${user.id}">
                <td>
                    <input type="checkbox" class="form-check-input user-checkbox" value="${user.id}">
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-2">
                            <span class="text-white small fw-bold">${user.username.charAt(0).toUpperCase()}</span>
                        </div>
                        <div>
                            <div class="fw-semibold">${user.username}</div>
                            <small class="text-muted">${user.first_name || ''} ${user.last_name || ''}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <div>
                        ${user.email}
                        ${user.email_verified ? 
                            '<span class="badge bg-success ms-1" title="Email verified"><i class="fas fa-check"></i></span>' :
                            '<span class="badge bg-warning ms-1" title="Email not verified"><i class="fas fa-exclamation-triangle"></i></span>'
                        }
                    </div>
                </td>
                <td>
                    <span class="badge bg-{{ 'success' if user.active else 'danger' }}">
                        ${user.active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>
                    <span class="badge bg-{{ 'primary' if user.is_admin else 'secondary' }}">
                        ${user.is_admin ? 'Admin' : 'User'}
                    </span>
                </td>
                <td>
                    <small class="text-muted">
                        ${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}
                    </small>
                </td>
                <td>
                    <small class="text-muted">${new Date(user.created_at).toLocaleDateString()}</small>
                </td>
                <td class="text-end">
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary edit-user-btn" title="Edit User" data-user-id="${user.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-outline-${user.active ? 'warning' : 'success'} toggle-status-btn" title="${user.active ? 'Deactivate' : 'Activate'} User" data-user-id="${user.id}">
                            <i class="fas fa-${user.active ? 'ban' : 'check'}"></i>
                        </button>
                        ${user.id !== {{ session.get('user_id') }} ? `
                        <button type="button" class="btn btn-outline-danger delete-user-btn" title="Delete User" data-user-id="${user.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function filterUsers() {
        const searchTerm = document.getElementById('userSearch').value.toLowerCase();
        const statusFilter = document.getElementById('userStatusFilter').value;
        const roleFilter = document.getElementById('userRoleFilter').value;

        const rows = document.querySelectorAll('#usersTableBody tr');

        rows.forEach(row => {
            const userData = row.dataset.userId;
            if (!userData) return;

            const username = row.querySelector('.fw-semibold').textContent.toLowerCase();
            const email = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
            const status = row.querySelector('.badge').textContent.toLowerCase();
            const role = row.querySelector('td:nth-child(5) .badge').textContent.toLowerCase();

            let show = true;

            // Search filter
            if (searchTerm && !username.includes(searchTerm) && !email.includes(searchTerm)) {
                show = false;
            }

            // Status filter
            if (statusFilter && !status.includes(statusFilter)) {
                show = false;
            }

            // Role filter
            if (roleFilter && !role.includes(roleFilter)) {
                show = false;
            }

            row.style.display = show ? '' : 'none';
        });
    }

    function updateBulkActions() {
        const checkboxes = document.querySelectorAll('.user-checkbox');
        const checked = document.querySelectorAll('.user-checkbox:checked');

        document.getElementById('selectedCount').textContent = checked.length;
        document.getElementById('bulkActions').classList.toggle('d-none', checked.length === 0);

        // Update select all checkbox
        const selectAll = document.getElementById('selectAllUsers');
        selectAll.indeterminate = checked.length > 0 && checked.length < checkboxes.length;
        selectAll.checked = checked.length === checkboxes.length;
    }

    function createNewUser() {
        const form = document.getElementById('addUserForm');
        const formData = new FormData(form);

        const userData = {
            username: document.getElementById('newUsername').value,
            email: document.getElementById('newEmail').value,
            firstName: document.getElementById('newFirstName').value,
            lastName: document.getElementById('newLastName').value,
            password: document.getElementById('newPassword').value,
            is_active: document.getElementById('newIsActive').checked,
            is_admin: document.getElementById('newIsAdmin').checked
        };

        // Basic validation
        if (!userData.username || !userData.email || !userData.password) {
            showModalError('addUserError', 'addErrorMessage', 'Please fill in all required fields');
            return;