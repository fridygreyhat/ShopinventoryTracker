{% extends "base.html" %}

{% block title %}Route Map - Application Routes{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Application Route Map</h1>
            <p class="text-muted">Complete mapping of all application routes and endpoints</p>
        </div>
        <div>
            <button class="btn btn-primary" onclick="exportRoutes()">
                <i class="fas fa-download me-2"></i>Export Routes
            </button>
        </div>
    </div>

    <!-- Route Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h3 class="text-primary mb-1" id="total-routes">111</h3>
                    <p class="text-muted mb-0">Total Routes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h3 class="text-success mb-1" id="total-blueprints">6</h3>
                    <p class="text-muted mb-0">Blueprints</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h3 class="text-info mb-1" id="total-files">6</h3>
                    <p class="text-muted mb-0">Route Files</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h3 class="text-warning mb-1" id="filtered-count">111</h3>
                    <p class="text-muted mb-0">Filtered Routes</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Search Routes</label>
                    <input type="text" class="form-control" id="search-input" placeholder="Search by path, function, or blueprint...">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Filter by Blueprint</label>
                    <select class="form-select" id="blueprint-filter">
                        <option value="">All Blueprints</option>
                        <option value="main">Main App</option>
                        <option value="auth">Authentication</option>
                        <option value="admin_portal">Admin Portal</option>
                        <option value="admin">Admin Routes</option>
                        <option value="sms">SMS Management</option>
                        <option value="language">Language</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Filter by Method</label>
                    <select class="form-select" id="method-filter">
                        <option value="">All Methods</option>
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-times me-1"></i>Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Route Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Application Routes</h5>
            <span class="badge bg-primary" id="route-count">111 routes</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="routes-table">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 35%">Route Path</th>
                            <th style="width: 15%">Methods</th>
                            <th style="width: 15%">Blueprint</th>
                            <th style="width: 20%">Function</th>
                            <th style="width: 15%">File</th>
                        </tr>
                    </thead>
                    <tbody id="routes-tbody">
                        <!-- Routes will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Blueprint Summary -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Blueprint Summary</h5>
        </div>
        <div class="card-body">
            <div class="row" id="blueprint-summary">
                <!-- Blueprint cards will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
// Global route data - loaded from API
let routeData = {
    routes: [],
    blueprints: {},
    total_routes: 0,
    files_analyzed: 0
};

let filteredRoutes = [...routeData.routes];

function renderRoutes() {
    const tbody = document.getElementById('routes-tbody');
    tbody.innerHTML = '';
    
    filteredRoutes.forEach(route => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <code class="text-primary">${route.full_path}</code>
            </td>
            <td>
                ${route.methods.map(method => 
                    `<span class="badge bg-${getMethodColor(method)} me-1">${method}</span>`
                ).join('')}
            </td>
            <td>
                <span class="badge bg-secondary">${route.blueprint}</span>
            </td>
            <td>
                <code>${route.function}</code>
            </td>
            <td>
                <small class="text-muted">${route.file}</small>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    document.getElementById('filtered-count').textContent = filteredRoutes.length;
    document.getElementById('route-count').textContent = `${filteredRoutes.length} routes`;
}

function getMethodColor(method) {
    const colors = {
        'GET': 'success',
        'POST': 'primary',
        'PUT': 'warning',
        'DELETE': 'danger',
        'PATCH': 'info'
    };
    return colors[method] || 'secondary';
}

function renderBlueprintSummary() {
    const container = document.getElementById('blueprint-summary');
    container.innerHTML = '';
    
    Object.values(routeData.blueprints).forEach(blueprint => {
        const col = document.createElement('div');
        col.className = 'col-md-4 mb-3';
        col.innerHTML = `
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-title">${blueprint.name}</h6>
                    <p class="text-muted mb-1">Prefix: <code>${blueprint.prefix || '/'}</code></p>
                    <p class="text-muted mb-1">File: <code>${blueprint.file}</code></p>
                    <p class="mb-0"><strong>${blueprint.route_count}</strong> routes</p>
                </div>
            </div>
        `;
        container.appendChild(col);
    });
}

function applyFilters() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const blueprintFilter = document.getElementById('blueprint-filter').value;
    const methodFilter = document.getElementById('method-filter').value;
    
    filteredRoutes = routeData.routes.filter(route => {
        const matchesSearch = !searchTerm || 
            route.full_path.toLowerCase().includes(searchTerm) ||
            route.function.toLowerCase().includes(searchTerm) ||
            route.blueprint.toLowerCase().includes(searchTerm);
            
        const matchesBlueprint = !blueprintFilter || route.blueprint === blueprintFilter;
        const matchesMethod = !methodFilter || route.methods.includes(methodFilter);
        
        return matchesSearch && matchesBlueprint && matchesMethod;
    });
    
    renderRoutes();
}

function clearFilters() {
    document.getElementById('search-input').value = '';
    document.getElementById('blueprint-filter').value = '';
    document.getElementById('method-filter').value = '';
    filteredRoutes = [...routeData.routes];
    renderRoutes();
}

function exportRoutes() {
    const csvContent = "data:text/csv;charset=utf-8," + 
        "Route Path,Methods,Blueprint,Function,File\n" +
        filteredRoutes.map(route => 
            `"${route.full_path}","${route.methods.join(', ')}","${route.blueprint}","${route.function}","${route.file}"`
        ).join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "application_routes.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Event listeners
document.getElementById('search-input').addEventListener('input', applyFilters);
document.getElementById('blueprint-filter').addEventListener('change', applyFilters);
document.getElementById('method-filter').addEventListener('change', applyFilters);

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    renderRoutes();
    renderBlueprintSummary();
});
</script>
{% endblock %}