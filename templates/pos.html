{% extends "base.html" %}

{% block title %}Point of Sale - Business Management System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-cash-register"></i> Point of Sale</h1>
    <button type="button" class="btn btn-warning" onclick="clearCart()">
        <i class="fas fa-trash"></i> Clear Cart
    </button>
</div>

<div class="row">
    <!-- Product Selection -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-boxes"></i> Available Items</h5>
            </div>
            <div class="card-body">
                <!-- Search Bar -->
                <div class="mb-3">
                    <input type="text" class="form-control" id="itemSearch" placeholder="Search items..." onkeyup="filterItems()">
                </div>
                
                <!-- Items Grid -->
                <div class="row g-3" id="itemsGrid">
                    {% for item in items %}
                    <div class="col-md-6 col-xl-4 item-card" data-name="{{ item.name.lower() }}">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">{{ item.name }}</h6>
                                <p class="card-text">
                                    <strong>${{ "%.2f"|format(item.price) }}</strong><br>
                                    <small class="text-muted">Stock: {{ item.stock_quantity }}</small><br>
                                    <small class="text-muted">{{ item.category.name }}</small>
                                </p>
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control" id="qty_{{ item.id }}" 
                                           min="1" max="{{ item.stock_quantity }}" value="1">
                                    <button class="btn btn-primary" onclick="addToCart({{ item.id }}, '{{ item.name }}', {{ item.price }}, {{ item.stock_quantity }})">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% if not items %}
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-muted mb-3"></i>
                    <h5>No items available</h5>
                    <p class="text-muted">No items with stock available for sale</p>
                    <a href="{{ url_for('inventory') }}" class="btn btn-primary">
                        <i class="fas fa-boxes"></i> Manage Inventory
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Shopping Cart -->
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header">
                <h5><i class="fas fa-shopping-cart"></i> Shopping Cart</h5>
            </div>
            <div class="card-body">
                <div id="cartItems">
                    <div class="text-center text-muted" id="emptyCart">
                        <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                        <p>Cart is empty</p>
                    </div>
                </div>
                
                <!-- Cart Summary -->
                <div id="cartSummary" style="display: none;">
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span>Subtotal:</span>
                        <span id="subtotal">$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Tax Rate (%):</span>
                        <input type="number" class="form-control form-control-sm" id="taxRate" 
                               value="0" min="0" max="50" step="0.1" onchange="updateTotals()">
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Tax:</span>
                        <span id="taxAmount">$0.00</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <strong>Total:</strong>
                        <strong id="total">$0.00</strong>
                    </div>
                    
                    <!-- Payment Method -->
                    <div class="mt-3">
                        <label for="paymentMethod" class="form-label">Payment Method</label>
                        <select class="form-select" id="paymentMethod">
                            <option value="cash">Cash</option>
                            <option value="card">Card</option>
                            <option value="digital">Digital Payment</option>
                        </select>
                    </div>
                    
                    <!-- Checkout Button -->
                    <button class="btn btn-success w-100 mt-3" onclick="processCheckout()">
                        <i class="fas fa-credit-card"></i> Process Payment
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Checkout Form -->
<form id="checkoutForm" method="POST" action="{{ url_for('process_sale') }}" style="display: none;">
    <input type="hidden" name="tax_rate" id="hiddenTaxRate">
    <input type="hidden" name="payment_method" id="hiddenPaymentMethod">
</form>
{% endblock %}

{% block scripts %}
<script>
let cart = [];

function addToCart(itemId, itemName, itemPrice, maxStock) {
    const qtyInput = document.getElementById(`qty_${itemId}`);
    const quantity = parseInt(qtyInput.value) || 1;
    
    if (quantity <= 0 || quantity > maxStock) {
        alert(`Invalid quantity. Maximum available: ${maxStock}`);
        return;
    }
    
    // Check if item already in cart
    const existingItemIndex = cart.findIndex(item => item.id === itemId);
    
    if (existingItemIndex !== -1) {
        const newQuantity = cart[existingItemIndex].quantity + quantity;
        if (newQuantity > maxStock) {
            alert(`Cannot add more. Maximum available: ${maxStock}`);
            return;
        }
        cart[existingItemIndex].quantity = newQuantity;
    } else {
        cart.push({
            id: itemId,
            name: itemName,
            price: itemPrice,
            quantity: quantity
        });
    }
    
    updateCartDisplay();
    qtyInput.value = 1;
    
    // Send to server
    fetch('/api/add_to_cart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `item_id=${itemId}&quantity=${quantity}`
    });
}

function updateCartDisplay() {
    const cartItemsDiv = document.getElementById('cartItems');
    const emptyCart = document.getElementById('emptyCart');
    const cartSummary = document.getElementById('cartSummary');
    
    if (cart.length === 0) {
        emptyCart.style.display = 'block';
        cartSummary.style.display = 'none';
        cartItemsDiv.innerHTML = '<div class="text-center text-muted" id="emptyCart"><i class="fas fa-shopping-cart fa-2x mb-2"></i><p>Cart is empty</p></div>';
        return;
    }
    
    emptyCart.style.display = 'none';
    cartSummary.style.display = 'block';
    
    let cartHTML = '';
    cart.forEach(item => {
        cartHTML += `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                <div>
                    <strong>${item.name}</strong><br>
                    <small>$${item.price.toFixed(2)} x ${item.quantity}</small>
                </div>
                <div class="text-end">
                    <div>$${(item.price * item.quantity).toFixed(2)}</div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${item.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    cartItemsDiv.innerHTML = cartHTML;
    updateTotals();
}

function removeFromCart(itemId) {
    cart = cart.filter(item => item.id !== itemId);
    updateCartDisplay();
    
    // Send to server
    fetch('/api/remove_from_cart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `item_id=${itemId}`
    });
}

function clearCart() {
    if (cart.length === 0) return;
    
    if (confirm('Are you sure you want to clear the cart?')) {
        cart = [];
        updateCartDisplay();
        
        // Send to server
        fetch('/api/clear_cart', {
            method: 'POST'
        });
    }
}

function updateTotals() {
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const taxRate = parseFloat(document.getElementById('taxRate').value) / 100;
    const taxAmount = subtotal * taxRate;
    const total = subtotal + taxAmount;
    
    document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('taxAmount').textContent = `$${taxAmount.toFixed(2)}`;
    document.getElementById('total').textContent = `$${total.toFixed(2)}`;
}

function processCheckout() {
    if (cart.length === 0) {
        alert('Cart is empty!');
        return;
    }
    
    const taxRate = document.getElementById('taxRate').value;
    const paymentMethod = document.getElementById('paymentMethod').value;
    
    document.getElementById('hiddenTaxRate').value = taxRate;
    document.getElementById('hiddenPaymentMethod').value = paymentMethod;
    
    if (confirm('Process this sale?')) {
        document.getElementById('checkoutForm').submit();
    }
}

function filterItems() {
    const searchTerm = document.getElementById('itemSearch').value.toLowerCase();
    const items = document.querySelectorAll('.item-card');
    
    items.forEach(item => {
        const itemName = item.getAttribute('data-name');
        if (itemName.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// Load cart from server on page load
window.addEventListener('load', function() {
    fetch('/api/get_cart')
        .then(response => response.json())
        .then(data => {
            cart = data.cart || [];
            updateCartDisplay();
        });
});
</script>
{% endblock %}
